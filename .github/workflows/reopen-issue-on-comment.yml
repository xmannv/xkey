name: Reopen Issue on New Comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  reopen-if-closed:
    runs-on: ubuntu-latest
    # Only run when issue is closed and comment is not from a bot
    if: |
      github.event.issue.state == 'closed' &&
      github.event.comment.user.type != 'Bot'

    steps:
      - name: Check and reopen issue
        uses: actions/github-script@v7
        id: reopen
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const commentCreatedAt = new Date(context.payload.comment.created_at);
            
            // Get issue details to check closed_at time
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const issueClosedAt = new Date(issue.data.closed_at);
            
            // Calculate time difference between issue close and comment creation
            const timeDiffSeconds = Math.abs(commentCreatedAt - issueClosedAt) / 1000;
            
            console.log(`ðŸ“Š Issue closed at: ${issueClosedAt.toISOString()}`);
            console.log(`ðŸ“Š Comment created at: ${commentCreatedAt.toISOString()}`);
            console.log(`ðŸ“Š Time difference: ${timeDiffSeconds} seconds`);
            
            // Check if commenter is the issue author
            const isAuthor = commenter === context.payload.issue.user.login;
            
            // Check if commenter is owner or collaborator
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const isOwner = commenter === repo.data.owner.login;
            
            let isCollaborator = false;
            try {
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: commenter
              });
              isCollaborator = ['admin', 'write'].includes(permission.data.permission);
            } catch (e) {
              isCollaborator = false;
            }
            
            // Issue authors can close their own issues even without collaborator access
            const hasWriteAccess = isOwner || isCollaborator || isAuthor;
            
            // If commenter has write access AND comment was created within 10 seconds of issue close,
            // this is likely a "Close with comment" action - don't reopen
            if (hasWriteAccess && timeDiffSeconds < 10) {
              console.log(`â„¹ï¸ Skipped reopening - detected "Close with comment" action by @${commenter}`);
              core.setOutput('reopened', 'false');
              core.setOutput('reason', 'close_with_comment');
              return;
            }
            
            // Reopen the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'open'
            });
            
            console.log(`âœ… Reopened issue #${context.issue.number}`);
            core.setOutput('reopened', 'true');
            
            // Add comment explaining reopen (skip if commenter has write access)
            if (!hasWriteAccess) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ðŸ”„ Issue Ä‘Ã£ Ä‘Æ°á»£c tá»± Ä‘á»™ng má»Ÿ láº¡i do cÃ³ comment má»›i tá»« @' + commenter
              });
              console.log(`âœ… Added reopen comment`);
            } else {
              console.log(`â„¹ï¸ Skipped adding comment (commenter @${commenter} has write access)`);
            }

      - name: Summary
        run: |
          if [ "${{ steps.reopen.outputs.reopened }}" == "true" ]; then
            echo "âœ… Issue #${{ github.event.issue.number }} Ä‘Ã£ Ä‘Æ°á»£c reopen" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Issue #${{ github.event.issue.number }} KHÃ”NG Ä‘Æ°á»£c reopen (phÃ¡t hiá»‡n 'Close with comment')" >> $GITHUB_STEP_SUMMARY
          fi
          echo "ðŸ‘¤ Comment tá»«: @${{ github.event.comment.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Issue URL: ${{ github.event.issue.html_url }}" >> $GITHUB_STEP_SUMMARY

